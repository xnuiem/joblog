version: 2.1

orbs:
  python: circleci/python@1.5.0

# Define a job to be invoked later in a workflow.
# See: https://circleci.com/docs/2.0/configuration-reference/#jobs
jobs:
  build-and-test:
    working_directory: ~/my-project

    docker:
      - image: cimg/python:3.10.2
      - image: cimg/redis:7.0
    steps:
      - checkout

      - python/install-packages:
          app-dir: ./backend
          pkg-manager: pip

      - run:
          name: Run tests
          command: |
            mkdir test-reports/
            pytest -ra --junitxml=test-reports/report.xml ./backend/joblog/tests/tests.py

      - run:
          name: run coverage
          command: |
            python -m coverage xml run -m pytest backend/joblog/tests/tests.py
            python -m coverage report

      - store_artifacts:
          path: test-reports/
          destination: tr1

      - store_artifacts:
          path: test-reports/

# Invoke jobs via workflows
# See: https://circleci.com/docs/2.0/configuration-reference/#workflows
workflows:
  pre-merge:
    jobs:
      - build-and-test
      
      
